from openai import OpenAI
import keyring
from typing import List, Dict
import datetime
from pathlib import Path

RULES = r"""
Общие правила:
⟦ 1 ⟧ ⋅ На сервере действуют правила сообщества Discord.

⟦ 2 ⟧ . Нецензурная брань разрешена, но без злоупотреблений.

⟦ 3 ⟧ . Оскорблять других пользователей запрещено.

⟦ 4 ⟧ . Злоупотребление ЗАГЛАВНЫМИ БУКВАМИ запрещено.

⟦ 5 ⟧ . Все виды флуда запрещены.

⟦ 6 ⟧ . Жесткий троллинг запрещен.

⟦ 7 ⟧ ⋅ Реклама других серверов и любого контента, который не относится к данному серверу разрешена только после согласия администрации (к этому правилу относится рассылка рекламы и любого другого контента в личные сообщения пользователей ресурса).

⟦ 8 ⟧ ⋅ Запрещена клевета на других пользователей. Если вы хотите оставить жалобу на пользователя или обвинить его в чем-либо, будьте готовы предоставить доказательства. В случае, если информация на прилагаемых доказательствах(скриншоты / голосовые записи) была вырвана из контекста, то последует наказание на усмотрение администрации.

⟦ 9 ⟧ ⋅ Запрещено распространение личной информации и данных пользователя(ей) без их согласия: ФИО/ФИ/ФО/ИО, место жительства, работы, учебы, адреса страниц и профилей. Фото и видеоматериалы, на которых изображены лицо, внешность пользователя (не только в рамках сервера, но и в лс).

⟦ 10 ⟧ ⋅ Запрещается обходить блокировку у пользователей или на сервере. Не отправляйте многократные нежелательные запросы дружбы или сообщения пользователю, который дал понять, что не хочет получать от вас сообщения. Не выдавайте себя за другого в попытке связаться с тем, кто заблокировал вас, и не пытайтесь иными способами обойти инструменты, созданные для защиты пользователей.

⟦ 11 ⟧ . Нельзя использовать NSWF контент вне каналов предназначенных для этого.

⟦ 12 ⟧ ⋅ Запрещается в любом виде сексуализировать несовершеннолетних. Это означает, что на платформе нельзя распространять контент или ссылки на контент, в котором несовершеннолетние лица представлены в сексуальных сценах, изображения с намёком на сексуальность, с порнографией или с жестокостью, и материалы, которые содержат иллюстрации или изменённые цифровым образом порнографические изображения с несовершеннолетними.

⟦ 13 ⟧ ⋅ Запрещается делиться контентом откровенно сексуального содержания с другими людьми без их согласия, а также распространять или поощрять несогласованное распространение интимных изображений (также известное как порноместь) с целью опозорить другого человека.

_____
Текстовые каналы:
⟦ 1 ⟧ ⋅ Запрещено чрезмерное упоминание определенного пользователя (в том числе бесцельное упоминание вне контекста), а также упоминание представителей Администрации без веской на то причины

⟦ 2 ⟧ ⋅ Запрещено упоминание каких либо ролей без причины.

⟦ 3 ⟧ ⋅ Не рекомендуется отправлять по одному слову в одном сообщении, вместо цельного предложения. Мультипостинг будет рассматриваться как попытка накрутки уровня.

_____
Голосовые каналы:
⟦ 1 ⟧ ⋅ Запрещено препятствовать общению людей, которые находятся в голосовом канале.

⟦ 2 ⟧ ⋅ Запрещено красть музыкальных ботов или намеренно мешать другим пользователям слушать музыку

⟦ 3 ⟧ ⋅ Прыгать из канала в канал или многократно перезаходить на один и тот же канал.

⟦ 4 ⟧ . Вы не можете включить музыку в микрофон.

⟦ 6 ⟧ ⋅ Если в окрестностях есть шум, рекомендуется применять «режим рации».

⟦ 5 ⟧ ⋅ Если Вы заметили нарушение правил голосовых каналов, следует сообщить об этом модерации. После 5 жалоб от разных участников, модератор вправе предусмотреть наказание для пользователя

_____
Ники и аватары:
⟦ 1 ⟧ ⋅ Администратор имеет право требовать изменения псевдонима и
изображения, если считает их оскорбительными для кого-либо.

⟦ 2 ⟧ ⋅ Запрещено использование никнеймов, оскорбляющих других пользователей (как в открытом виде, так и в завуалированном), а также провокационных никнеймов (например: аниме говно / против яоя / за яой и подобные).

⟦ 3 ⟧ ⋅ Запрещено использовать фото профиля или никнеймы других участников, и представителей Администрации и Модерации, так как это вводит пользователей ресурса в заблуждение.

⟦ 4 ⟧ . Использование символики террористов и запрещенных организаций, призыв к насилию и экстремизму не допускается.

⟦ 6 ⟧ ⋅ Нельзя использовать бессмысленный набор символов с повторным повторением одной или нескольких букв в нике.
"""

CHAT_GPT_TOKEN = keyring.get_password('discord_bot', 'token_chatGPT')
if CHAT_GPT_TOKEN is None:
    CHAT_GPT_TOKEN = input('Write Token: ')
    keyring.set_password('discord_bot', 'token_chatGPT', CHAT_GPT_TOKEN)
    CHAT_GPT_TOKEN = keyring.get_password('discord_bot', 'token_chatGPT')
client = OpenAI(base_url='https://api.naga.ac/v1', api_key=CHAT_GPT_TOKEN)


class MilesEdgeworth:
    def __init__(self):
        self.client = client
        self.model = 'llama-3.3-70b-instruct'
        # self.rule_path = Path('data/rules.txt')
        self.rule_path = RULES
        self.reporter_id = None
        self.reported_id = None
        self.conversation_text = None
        self.rules = None
        self.reason = None

    def _generate_system_prompt(self) -> str:
        if not self.rules:
            self.rules = self.rule_path
        return f"""
    Вы выступаете в качестве беспристрастного эксперта по модерации Discord.
    Истец (ID: {self.reporter_id}) предъявил исковое требование Ответчику (ID: {self.reported_id}) с причиной (f{self.reason}).

    Пожалуйста, предоставьте:
    1. Краткое содержание диалога между пользователями.
    2. Оценку возможных нарушений правил или неадекватного поведения.
    3. Оценку серьезности нарушений (нет, незначительные, умеренные, серьезные).
    Разговор:
    4. Рекомендации к действию со стороны администрации к отношению истцу и\или ответчику
    {self.conversation_text}

    Правила сервера:
    {self.rules}
    """

    def format_message(self, messages: List[Dict]) -> str:
        """Format collected messages into a readable text format"""
        conversation = "CONVERSATION HISTORY\n"
        conversation += "=" * 50 + "\n\n"

        # Sort messages by timestamp
        messages.sort(key=lambda x: x["timestamp"])

        for msg in messages:
            timestamp = datetime.datetime.fromisoformat(msg["timestamp"]).strftime("%Y-%m-%d %H:%M:%S")
            conversation += f"[{timestamp}] {msg['author_name']} ({msg['author_id']}):\n"
            conversation += f"{msg['content']}\n"

            if msg["attachments"]:
                conversation += "Attachments:\n"
                for url in msg["attachments"]:
                    conversation += f"- {url}\n"

            conversation += "\n" + "-" * 40 + "\n\n"

        return conversation

    def judge(self, reporter_id, reported_id, conversation_text, reason) -> str:
        self.reporter_id = reporter_id
        self.reported_id = reported_id
        self.conversation_text = conversation_text
        self.rules = self.rule_path
        self.reason = reason
        system_prompt = self._generate_system_prompt()
        completion = client.chat.completions.create(
            model=self.model,
            messages=[
                {
                    "role": "system",
                    "content": system_prompt
                }
            ],
            temperature=0,
            max_tokens=2048
        )
        return completion.choices[0].message.content
